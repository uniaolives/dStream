<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>dStream Mint Overlay</title>
  <style>
    body{margin:0;background:rgba(0,0,0,0);color:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
    #wrap{position:absolute;top:20px;right:20px;display:flex;gap:12px;align-items:center}
    button{padding:10px 18px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
    #connect{background:#1e88e5;color:#fff}
    #mint{background:#e91e63;color:#fff;opacity:0;transition:opacity .3s}
    #mint.show{opacity:1}
    canvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-1}
  </style>
</head>
<body>
  <canvas id="viz"></canvas>
  <div id="wrap">
    <button id="connect">Connect Wallet</button>
    <button id="mint" class="show">Mint Moment</button>
  </div>

  <script type="module">
    import { ethers } from "https://cdn.skypack.dev/ethers@5.7.2";

    /* ---------- config (your final values) ---------- */
    const CHAIN_ID = 80001;                       // Mumbai
    const RPC      = "https://rpc-mumbai.maticvigil.com";
    const NFT_ADDR = "0x3Dc06f3Df71DA7F23fA2Ff3949D78Cc7a6EDd5c3";
    const ABI      = [{"inputs":[{"internalType":"string","name":"ipfsHash","type":"string"}],"name":"mint","outputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"stateMutability":"nonpayable","type":"function"}];

    /* ---------- wallet ---------- */
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer   = provider.getSigner();
    const contract = new ethers.Contract(NFT_ADDR, ABI, signer);

    /* ---------- buttons ---------- */
    const connectBtn = document.getElementById("connect")!;
    const mintBtn    = document.getElementById("mint")!;

    connectBtn.onclick = async () => {
      await provider.send("eth_requestAccounts", []);
      connectBtn.textContent = "Connected";
    };

    mintBtn.onclick = async () => {
      const hash = prompt("IPFS hash (CID only):");
      if (!hash) return;
      const tx = await contract.mint(hash);
      await tx.wait();
      alert("Minted! tx: " + tx.hash);
    };

    /* ---------- FFT visualiser ---------- */
    const canvas = document.getElementById("viz") as HTMLCanvasElement;
    const ctx    = canvas.getContext("2d")!;
    function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    addEventListener("resize", resize); resize();
    const audio = new Audio();
    audio.crossOrigin = "anonymous";
    audio.src = "https://gateway.pinata.cloud/ipfs/QmXxXx/loop.mp3";
    audio.play().catch(()=>{});
    const audCtx = new AudioContext();
    const src = audCtx.createMediaElementSource(audio);
    const analyser = audCtx.createAnalyser();
    analyser.fftSize = 256;
    src.connect(analyser); analyser.connect(audCtx.destination);
    const data = new Uint8Array(analyser.frequencyBinCount);
    function draw(){
      requestAnimationFrame(draw);
      analyser.getByteFrequencyData(data);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const bar = canvas.width / data.length;
      for(let i=0;i<data.length;i++){
        const h = (data[i]/255)*canvas.height*0.8;
        ctx.fillStyle = `hsl(${(i/data.length)*360},90%,50%)`;
        ctx.fillRect(i*bar, canvas.height-h, bar-2, h);
      }
    }
    draw();
  </script>
</body>
</html>
